# Django_proj/insight/views_insight.py

import json, re
from datetime import date

from django.views.decorators.csrf import csrf_exempt
from django.views.decorators.http import require_http_methods
from django.http import JsonResponse

from langchain_openai import ChatOpenAI


# ===========================
#  LLM ì´ˆê¸°í™” (gpt-4o)
# ===========================

llm_consistent = None
try:
    llm_consistent = ChatOpenAI(
        model='gpt-4o',
        api_key=key,
        temperature=0,
        max_tokens=1000,
        top_p=0.3,
        frequency_penalty=0.1,
    )
except Exception as e:
    print(f"âš ï¸ ChatOpenAI ì´ˆê¸°í™” ì‹¤íŒ¨: {e}")


# ===========================
# 3ë‹¨ê³„ stage3 ê²€ì¦ ìœ í‹¸
# ===========================

REQUIRED_STAGE3_KEYS = ["sql", "opinion", "main", "sub", "count", "data"]

def _strip_md_fence(content: str) -> str:
    if not isinstance(content, str):
        return content

    text = content.strip()

    # ì‹œì‘ì´ ```ë¡œ ì‹œì‘í•˜ë©´ ì–¸ì–´ íƒœê·¸(json ë“±)ê¹Œì§€ ì œê±°
    if text.startswith("```"):
        # ì²« ì¤„: ``` ë˜ëŠ” ```json ì´ëŸ° ê±° ì œê±°
        lines = text.splitlines()
        if lines:
            first = lines[0]
            if first.startswith("```"):
                lines = lines[1:]  # ì²« ì¤„ ë²„ë¦¬ê³ 
        text = "\n".join(lines).strip()

        # ë§ˆì§€ë§‰ ì¤„ì´ ``` ì´ë©´ ì œê±°
        if text.endswith("```"):
            text = text[: -3].strip()

    return text

def _validate_stage3(stage3: dict):
    """
    rdb_gateway 3ë‹¨ê³„ ê²°ê³¼(stage3)ê°€ í•„ìˆ˜ í‚¤ë¥¼ ê°€ì§€ê³  ìˆëŠ”ì§€ ê²€ì¦.
    í•˜ë‚˜ë¼ë„ ì—†ìœ¼ë©´ ë°”ë¡œ JsonResponse ì—ëŸ¬ ë°˜í™˜.
    """
    for k in REQUIRED_STAGE3_KEYS:
        if k not in stage3:
            return JsonResponse({"error": f"stage3 missing '{k}'"}, status=400)
    return None

# ===========================
#  ë©”ì¸ ì—”ë“œí¬ì¸íŠ¸: ì¸ì‚¬ì´íŠ¸ ìƒì„±
# ===========================

@csrf_exempt
@require_http_methods(["POST"])
def generate_insight(request):

    # --------------------------------
    # 1) JSON íŒŒì‹±
    # --------------------------------
    try:
        body = json.loads(request.body or "{}")
    except Exception:
        return JsonResponse({"error": "JSON íŒŒì‹± ì‹¤íŒ¨"}, status=400)

    user_input = (body.get("user_input") or "").strip()
    stage3 = body.get("stage3") or {}

    if not isinstance(stage3, dict):
        return JsonResponse({"error": "stage3ëŠ” dictì—¬ì•¼ í•©ë‹ˆë‹¤."}, status=400)

    # --------------------------------
    # 2) stage3 í•„ìˆ˜ í‚¤ ê²€ì¦
    # --------------------------------
    err = _validate_stage3(stage3)
    if err is not None:
        return err

    # --------------------------------
    # 3) stage3 êµ¬ì„±ìš”ì†Œ êº¼ë‚´ê¸°
    # --------------------------------
    sql_text        = (stage3.get("sql") or "").strip()
    opinion         = (stage3.get("opinion") or "").strip()
    main            = stage3.get("main")
    sub             = stage3.get("sub")
    count           = int(stage3.get("count") or 0)
    sql_time        = stage3.get("sql_executed_time")
    rows_full       = stage3.get("data") or []
    retrieved_block = stage3.get("retrieved_block")


    retrieved_json = (
        "ì—†ìŒ" if retrieved_block is None
        else json.dumps(retrieved_block, ensure_ascii=False)
    )

    # --------------------------------
    # 4) LLM í”„ë¡¬í”„íŠ¸ ìƒì„±
    # --------------------------------
    prompt = f"""
[ROLE]
ë‹¹ì‹ ì€ íŒ¨ë„ ë°ì´í„° ë¶„ì„ê°€ì…ë‹ˆë‹¤. ì…ë ¥ìœ¼ë¡œ ì£¼ì–´ì§„ ì§ˆì˜ / íŒ¨ë„ / ì˜ê²¬ / ì°¸ê³ ë¬¸í—Œ(RAG)ì„ ë°”íƒ•ìœ¼ë¡œ
"ì´ë¯¸ ë§¤ìš° êµ¬ì²´ì ì¸ WHERE ì¡°ê±´"ì„ ë” í¬ê´„ì ì¸ ì¸ì‚¬ì´íŠ¸ë¡œ ìŠ¹ê²©í•˜ì—¬ ìš”ì•½Â·ì‹œê°í™” ì œì•ˆì„ í•©ë‹ˆë‹¤.

[DATA INPUTS]
- main = {main}
- sub = {sub}
- user_input: {user_input}
- sql: {sql_text}
- opinion: {opinion}
- panel: {json.dumps(rows_full, ensure_ascii=False)}
- result.count: {count}

[í•´ì‹œíƒœê·¸ ëª©ë¡]
#main "ì—¬ê°€ì™€ ë¬¸í™”"
- "ì—¬í–‰ ì´ì™¸ì˜ ëª¨ë“  ì˜¤í”„ë¼ì¸ ë¬¸í™”ìƒí™œ"
- "ì—¬í–‰ ê¸°ë°˜ ì˜¤í”„ë¼ì¸ ë¬¸í™”ìƒí™œ"
#main "ì¼ìƒ ìš”ì†Œ"
- "ê²½í—˜ ì¶”ì–µ ë“± ê³¼ê±°ì™€ ê´€ë ¨ëœ í–‰ë™"
- "í™˜ê²½ê³¼ ê´€ë ¨ëœ í–‰ë™"
- "ì¼ìƒì ìœ¼ë¡œ ë°˜ë³µí•˜ëŠ” í–‰ë™"
#main "ìŠ¤íƒ€ì¼ ì™¸ëª¨"
- "íŒ¨ì…˜ ê´€ë ¨ ë·°í‹°"
- "íŒ¨ì…˜ ì™¸ì ì¸ ë·°í‹°"
#main "ê¸°ìˆ  ë° ì •ë³´"
- "ë””ì§€í„¸ ë„êµ¬ í™œìš©"
#main "ì†Œë¹„ì™€ ì¬ì •"
- "ì†Œë¹„ë¥¼ í†µí•´ ì´ë“ì„ ì·¨í•˜ëŠ” ê²½ìš°"
- "ì†Œë¹„ë¥¼ í†µí•´ ê°€ì¹˜ê´€ì„ í‘œí˜„"
#main "ê±´ê°• ì›°ë¹™"
- "ì‹ ì²´ì  ê±´ê°•"
- "ì‹ ì²´ì Â·ì‹¬ì ì¸ ê±´ê°•"


[STRICT RULES]
1) ì ˆëŒ€ ìƒˆë¡œìš´ ë°ì´í„° ì¶”ì¸¡ ê¸ˆì§€. panel ë° [ì°¸ê³ ] ë¸”ë¡(retrieved_json)ë§Œ ê·¼ê±°ë¡œ ì‚¬ìš©í•œë‹¤.
2) ì™¸ë¶€ì™€ì˜ ë¹„êµê°€ ì•„ë‹Œ, íŒ¨ë„ ë‚´ë¶€ ëŒ€ë¹„(ì—°ë ¹ ì„¸ë¶„, loyalty, subregion, main/sub ë“±) ì¤‘ì‹¬ìœ¼ë¡œ í¬ê´„ ì¸ì‚¬ì´íŠ¸ë¥¼ ë„ì¶œí•œë‹¤.
3) ì„ ì • ì´ìœ , ì²´ì¸ ì˜¤ë¸Œ ì†ŒíŠ¸, LLM ì—°ì‚° ê³¼ì •ì€ ì–´ë–¤ í˜•íƒœë¡œë„ ì¶œë ¥í•˜ì§€ ì•ŠëŠ”ë‹¤.
   (ì„¤ëª… ë¬¸ì¥, ë§ˆí¬ë‹¤ìš´, ì£¼ì„, ë©”íƒ€ í…ìŠ¤íŠ¸ ëª¨ë‘ ê¸ˆì§€. ì˜¤ì§ ì§€ì •ëœ JSONë§Œ ì¶œë ¥í•œë‹¤.)
4) ì•„ë˜ [ì¶œë ¥ ì˜ˆì‹œ] JSONì˜ í‚¤ êµ¬ì¡°ì™€ ìë£Œí˜•ì„ ì—„ê²©íˆ ì§€í‚¨ë‹¤.
   - ë¬¸ìì—´ì€ ë¬¸ìì—´, ë°°ì—´ì€ ë°°ì—´, ê°ì²´ëŠ” ê°ì²´ë¡œ ìœ ì§€í•œë‹¤.
   - ë¶ˆí•„ìš”í•œ í•„ë“œ ì¶”ê°€ ê¸ˆì§€.


[charts]
1) panel ì¤‘ **opinionìœ¼ë¡œ ì¶”ì¶œëœ ìì—°ì–´ ì‘ë‹µì´ ì‘ì„±ëœ ì¹¼ëŸ¼(ì„œìˆ í˜• / ì£¼ê´€ì‹ ë¬¸í•­)**ë§Œ ë¶„ì„í•œë‹¤.
2) ê° ì¹¼ëŸ¼ë³„ ìì—°ì–´ ì‘ë‹µì˜ íŒ¨í„´ì„ íŒŒì•…í•˜ê³ , ì˜ë¯¸ê°€ ê°™ì€ í‘œí˜„ì€ í•˜ë‚˜ì˜ answer_groupìœ¼ë¡œ ë¬¶ì–´ì„œ ê°œìˆ˜(count)ë¥¼ ì„¼ë‹¤.
3) charts ë°°ì—´ì˜ ê° ì›ì†ŒëŠ” **í•˜ë‚˜ì˜ ì°¨íŠ¸ ì‚¬ì–‘ + ì‹¤ì œ ì§‘ê³„ ê²°ê³¼ rows**ë¥¼ ì˜ë¯¸í•œë‹¤.
   - "spec": ["<xì¶• ë³€ìˆ˜ëª…>", "<yì¶• ë³€ìˆ˜ëª…>", "<label ë˜ëŠ” ê·¸ë£¹ ê¸°ì¤€>"]
     - ì˜ˆì‹œ: ["answer_group", "count", "qpoll"]
   - "rows": [
       {{ "qpoll": "<ì§ˆë¬¸ID>", "answer_group": "<ì‘ë‹µ ê·¸ë£¹ ë¼ë²¨>", "count": <ì •ìˆ˜> }},
       ...
     ]
4) rowsì—ëŠ” panel ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì§‘ê³„í•œ ê²°ê³¼ë§Œ ë„£ê³ , ì„ì˜ë¡œ ìƒˆë¡œìš´ qpollì´ë‚˜ answer_group, countë¥¼ ìƒì„±í•˜ì§€ ì•ŠëŠ”ë‹¤.


[insight]
1) <title>
   - user_inputì„ ë°”íƒ•ìœ¼ë¡œ, sql ì¿¼ë¦¬ê°€ ì˜ë¯¸í•˜ëŠ” ì§‘ë‹¨ì„ ìì—°ì–´ë¡œ í’€ì–´ì„œ ì„¤ëª…í•œë‹¤.
   - panelì˜ ê° ì¹¼ëŸ¼ë³„ ì‘ë‹µì„ íŒŒì•…í•˜ì—¬, **ê°€ì¥ ì‘ë‹µì´ ë§ì´ ë‚˜ì˜¨ íŒ¨í„´**ì„ ëŒ€í‘œ ì‚¬ë¡€ë¡œ ì‚¼ì•„
     ì´ ì§‘ë‹¨ì„ ì„¤ëª…í•˜ë“¯ì´ ì œëª©ì„ ì •í•œë‹¤.
   - titleë§Œ ì½ì–´ë„ â€œì–´ë–¤ ì‚¬ëŒë“¤ì— ëŒ€í•œ ì¸ì‚¬ì´íŠ¸ì¸ì§€â€ ì§ê´€ì ìœ¼ë¡œ ì´í•´í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤.
2) context_5linesì˜ <ë¬¸ì¥1>
   - <title>ì„ ë°”íƒ•ìœ¼ë¡œ, ì´ ì§‘ë‹¨ì´ ì–´ë–¤ main / sub í•´ì‹œíƒœê·¸ì— í•´ë‹¹í•˜ëŠ”ì§€ ìì—°ìŠ¤ëŸ½ê²Œ í’€ì–´ì„œ ì„¤ëª…í•œë‹¤.
   - mainê³¼ subì˜ ì •ì˜ë¥¼ ì°¸ê³ í•˜ë˜, í•´ì‹œíƒœê·¸ë¥¼ ê·¸ëŒ€ë¡œ ë‚˜ì—´í•˜ì§€ ë§ê³  â€œí–‰ë™/íƒœë„/ìƒí™©â€ì˜ ë§¥ë½ìœ¼ë¡œ ë…¹ì—¬ë‚¸ë‹¤.
3) context_5linesì˜ <ë¬¸ì¥2>
   - <ë¬¸ì¥1>ì—ì„œ ì„¤ëª…í•œ main / sub íŒë‹¨ì˜ **ê·¼ê±°**ë¥¼ panel ì‘ë‹µë¹„ìœ¨ ê´€ì ì—ì„œ ì„œìˆ í•œë‹¤.
   - ì‚¬ìš©ì ì‘ë‹µ ë¹„ìœ¨(ì–´ë–¤ ìœ í˜•ì˜ ë‹µë³€ì´ ì–¼ë§ˆë‚˜ ë§ì´ ë“±ì¥í•˜ëŠ”ì§€)ì„ ì–¸ê¸‰í•˜ì—¬,
     ì™œ ì´ ì§‘ë‹¨ì´ í•´ë‹¹ main / subì— ì†í•œë‹¤ê³  ë³¼ ìˆ˜ ìˆëŠ”ì§€ ì„¤ëª…í•œë‹¤.
   - ì •í™•í•œ í¼ì„¼íŠ¸ ìˆ˜ì¹˜ë¥¼ ë§Œë“¤ì§€ ë§ê³ , â€œëŒ€ë¶€ë¶„ / ìƒë‹¹ìˆ˜ / ì¼ë¶€ / ì†Œìˆ˜â€ì™€ ê°™ì´ **ìƒëŒ€ì  ë¹„ìœ¨ í‘œí˜„**ë§Œ ì‚¬ìš©í•œë‹¤.
4) context_5linesì˜ <ë¬¸ì¥3>
   - keywords ë°°ì—´ì— ë“¤ì–´ê°ˆ 3ê°œì˜ í‚¤ì›Œë“œê°€ ë¬´ì—‡ì¸ì§€ ë’·ë°›ì¹¨í•˜ëŠ” ë¬¸ì¥ì„ ì‘ì„±í•œë‹¤.
   - user_inputê³¼ panel ì‘ë‹µì„ ë°”íƒ•ìœ¼ë¡œ, ì‚¬ìš©ìì˜ íŠ¹ì„±ì´ ì˜ ë“œëŸ¬ë‚˜ëŠ” í•µì‹¬ íŠ¹ì§• 3ê°€ì§€ë¥¼ ê³¨ë¼ keywordsë¡œ ì„ ì •í•˜ê³ ,
     <ë¬¸ì¥3>ì—ì„œëŠ” ì´ í‚¤ì›Œë“œë“¤ì´ ì´ ì§‘ë‹¨ì„ ì˜ ì„¤ëª…í•˜ëŠ” ì´ìœ ë¥¼ ìš”ì•½í•œë‹¤.
5) context_5linesì˜ <ë¬¸ì¥4>
   - user_inputì„ ê¸°ë°˜ìœ¼ë¡œ, â€œë°˜ëŒ€ ì§‘ë‹¨â€ê³¼ â€œìœ ì‚¬í•˜ì§€ë§Œ ë‹¤ë¥¸ ì§‘ë‹¨â€ì— ëŒ€í•œ ì¶”ê°€ íƒìƒ‰ ë°©í–¥ì„ ì œì•ˆí•˜ëŠ” ë¬¸ì¥ì„ ì‘ì„±í•œë‹¤.
   - ì˜ˆë¥¼ ë“¤ì–´,
     - ì§€ê¸ˆ ì§‘ë‹¨ê³¼ **ì •ë°˜ëŒ€ ì„±í–¥**ì„ ê°€ì§„ ì§‘ë‹¨ì„ ì–´ë–¤ ì§ˆì˜(sql + opinion)ë¡œ ì¡°íšŒí•´ë³¼ ìˆ˜ ìˆëŠ”ì§€,
     - main/sub ë˜ëŠ” ì—°ë ¹Â·ì„±ë³„ ë“± ì¼ë¶€ ì¡°ê±´ë§Œ ë°”ê¿”ì„œ **ìœ ì‚¬í•œ ë‹¤ë¥¸ ì§‘ë‹¨**ì„ ì–´ë–»ê²Œ ë¹„êµí•´ë³¼ ìˆ˜ ìˆëŠ”ì§€
       ë¥¼ ìì—°ìŠ¤ëŸ½ê²Œ ë…¹ì—¬ ì“´ë‹¤.
6) context_5linesì˜ <ë¬¸ì¥5>
   - ìœ„ ë‚´ìš©ì„ ì¢…í•©í•˜ì—¬, ì´ ì§‘ë‹¨ì— ëŒ€í•œ ì¸ì‚¬ì´íŠ¸ë¥¼ â€œí•œ ì¤„ ê²°ë¡ â€ì²˜ëŸ¼ ì •ë¦¬í•œë‹¤.
   - ì‹¤ì œ ì‹¤ë¬´ìê°€ ë°”ë¡œ ì•¡ì…˜ ì•„ì´ë””ì–´ë¥¼ ë– ì˜¬ë¦´ ìˆ˜ ìˆì„ ì •ë„ë¡œ, ê°„ê²°í•˜ê³  ì‹¤ìš©ì ì¸ ìš”ì•½ìœ¼ë¡œ ë§ˆë¬´ë¦¬í•œë‹¤.


[keywords]
- [insight]ì˜ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ í•µì‹¬ 2~3ìŒì ˆ ë‹¨ì–´ í‚¤ì›Œë“œ 3ê°œ ë¥¼ ì¶”ì¶œí•œë‹¤.
- main, sub, sql ì¡°ê±´, opinion í…ìŠ¤íŠ¸ì—ì„œ ì§ì ‘ ê°€ì ¸ì˜¤ì§€ ì•ŠëŠ”ë‹¤.
  - ì¦‰, main ì´ë¦„, sub ì´ë¦„, ì„±ë³„/ì—°ë ¹/ì§€ì—­ ê°™ì€ sql ì¡°ê±´, 
    ë˜ëŠ” user_inputì˜ opinion ë¬¸ì¥ì„ ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜¤ëŠ” ê²ƒì€ ê¸ˆì§€ì´ë‹¤.


[similar_queries]
user_inputê³¼ ìœ ì‚¬í•œ ì§ˆì˜ë¥¼ ì¶”ì²œí•´ ì‚¬ìš©ìì˜ ì—°ì†ì ì¸ ì‚¬ìš©ì„ ì´ëŒì–´ë‚´ê¸° ìœ„í•œ ìš©ë„ì´ë‹¤.
ì´ 3ê°œì˜ ì§ˆì˜ë¥¼ ì¶”ì²œí•œë‹¤.

1) ë°˜ëŒ€ ì§‘ë‹¨ ì§ˆì˜ (1ê°œ)
- í˜„ì¬ ì§‘ë‹¨ì˜ íŠ¹ì„±ì´ ëšœë ·í•˜ê²Œ ë“œëŸ¬ë‚˜ëŠ” ê²½ìš°,
  ì‚¬ëŒì˜ íŠ¹ì§•(sql ì¡°ê±´: ì„±ë³„, ì—°ë ¹, ì§€ì—­, loyalty ë“±)ì€ ìµœëŒ€í•œ ìœ ì§€í•˜ë©´ì„œ opinionë§Œ "ë°˜ëŒ€ ì˜ë¯¸"ë¡œ ë°”ê¾¼ë‹¤.
- ì˜ˆì‹œ ê°œë…: ì¢‹ì•„í•˜ëŠ” â†” ì‹«ì–´í•˜ëŠ”, ì˜í•˜ëŠ” â†” ëª»í•˜ëŠ”, ìì£¼ í•œë‹¤ â†” ê±°ì˜ í•˜ì§€ ì•ŠëŠ”ë‹¤

2) ìœ ì‚¬í•œ íŠ¹ì§•ì´ì§€ë§Œ ë‹¤ë¥¸ ì§‘ë‹¨ ì§ˆì˜ (2ê°œ)
- (ìœ ì‚¬ì¿¼ë¦¬1) ê°™ì€ main ë‚´ì—ì„œ, ë‹¤ë¥¸ subì— í•´ë‹¹í•˜ëŠ” ì¿¼ë¦¬ë¥¼ ì œì•ˆí•œë‹¤.
  ì˜ˆ: main "ì†Œë¹„ì™€ ì¬ì •" ì•ˆì—ì„œ, "ì†Œë¹„ë¥¼ í†µí•´ ì´ë“" â†’ "ì†Œë¹„ë¥¼ í†µí•´ ê°€ì¹˜ê´€ í‘œí˜„" ìœ¼ë¡œ ì „í™˜
- (ìœ ì‚¬ì¿¼ë¦¬2) main/subëŠ” ìœ ì§€í•˜ë˜ gender, age, marriage ë“± ì •ëŸ‰ì ì¸ ì‚¬ëŒì˜ íŠ¹ì§•(sql ì¡°ê±´)ë§Œ ë³€ê²½í•˜ì—¬
  ë¹„êµí•´ë³¼ ìˆ˜ ìˆëŠ” ì§ˆì˜ë¥¼ ë§Œë“ ë‹¤.


[ì¶œë ¥ ì˜ˆì‹œ]
{{
 "charts": [
   {{
     "spec": ["answer_group", "count", "qpoll"],
     "rows": [
       {{ "qpoll": "q8", "answer_group": "ì¥ë°”êµ¬ë‹ˆ/ì—ì½”ë°± í™œìš©", "count": 15 }},
       {{ "qpoll": "q3", "answer_group": "í¸ì˜ì ì—ì„œ ìš°ì‚° êµ¬ë§¤", "count": 3 }},
       {{ "qpoll": "q3", "answer_group": "ê·¼ì²˜ë¡œ ë›°ì–´ê°€ ë¹„ë¥¼ í”¼í•¨", "count": 10 }}
     ]
   }}
 ],
 "insight": {{
   "title": "í•œ ì¤„ ì œëª©",
   "keywords": ["<í‚¤1>", "<í‚¤2>", "<í‚¤3>"],
   "context_5lines": [
     "ë¬¸ì¥1",
     "ë¬¸ì¥2",
     "ë¬¸ì¥3",
     "ë¬¸ì¥4",
     "ë¬¸ì¥5"
   ]
 }},
 "similar_queries": [
   "<ë°˜ëŒ€ì¿¼ë¦¬>",
   "<ìœ ì‚¬ì¿¼ë¦¬1>",
   "<ìœ ì‚¬ì¿¼ë¦¬2>"
 ],
  "keywords": [
   "<keyword1>",
   "<keyword2>",
   "<keyword3>"
 ]

}}
[ì°¸ê³ ]
{retrieved_json}
"""

    # --------------------------------
    # 5) LLM í˜¸ì¶œ
    # --------------------------------
    try:
        result = llm_consistent.invoke(prompt)
        content = getattr(result, "content", str(result))

         # ğŸ” LLM ì›ë³¸ ì‘ë‹µ í™•ì¸ìš© ë””ë²„ê·¸
        print("=== [LLM RAW CONTENT] ===")
        # ë„ˆë¬´ ê¸¸ë©´ ì•ë¶€ë¶„ë§Œ ë³´ê³  ì‹¶ìœ¼ë©´ content[:1000] ì´ëŸ° ì‹ìœ¼ë¡œ ì˜ë¼ë„ ë¨
        print(content)
        print("=== [END LLM RAW CONTENT] ===")

    except Exception as e:
        return JsonResponse(
            {"error": f"LLM í˜¸ì¶œ ì‹¤íŒ¨: {type(e).__name__}: {e}"},
            status=500,
        )

    # --------------------------------
    # 6) JSON íŒŒì‹±
    # --------------------------------
    try:
        clean = _strip_md_fence(content)
        insight_obj = json.loads(clean)
    except Exception:
        # í˜¹ì‹œ ë˜ ì‹¤íŒ¨í•˜ë©´ rawë¡œ ê·¸ëŒ€ë¡œ ë…¸ì¶œ
        insight_obj = {"raw": content}

    # --------------------------------
    # 7) ìµœì¢… ì‘ë‹µ
    # --------------------------------
    return JsonResponse(
        {
            "stage3": {
                "sql": sql_text,
                "opinion": opinion,
                "main": main,
                "sub": sub,
                "count": count,
                "sql_executed_time": sql_time,
            },
            "insight": insight_obj,
        },
        json_dumps_params={"ensure_ascii": False},
    )
